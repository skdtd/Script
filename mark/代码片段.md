# [Scrapy详情页 (样例)](https://blog.csdn.net/zbrj12345/article/details/80511456)

```python
class TencentSpider(scrapy.Spider):
    name = 'tencent'
    allowed_domains = ['hr.tencent.com']
    start_urls = []
    base_url='https://hr.tencent.com/position.php?&start=%s#a'
    for i in range(0,1):
        url=base_url%(i-1)*10
        start_urls.append(url)

    def parse(self, response):
        job_even=response.xpath('//tr[@class="even"]')
        job_odd=response.xpath('//tr[@class="odd"]')
        #合并数组
        jobs=job_even+job_odd

        for job in jobs:
            print(job)
            item=TencentItem()
            #时间
            date=job.xpath('.//td[5]/text()').extract()[0]
            item['date']=date
            #地点
            location=job.xpath('.//td[4]/text()').extract()[0]
            item['location']=location
            #人数
            num = job.xpath('.//td[3]/text()').extract()[0]
            item['num'] = num
            #职位类别
            type = job.xpath('.//td[2]/text()').extract()[0]
            item['type'] = type
            #职位名称
            name=job.xpath('.//td[1]/a/text()').extract()[0]
            item['name']=name
            #链接
            url = job.xpath('.//td[1]/a/@href').extract()[0]
            # 比较低级
            # url='https://hr.tencent.com/'+url
            #高级  #拼接全路径
            url = request.urljoin(response.url,url)
            item['url'] = url
            print(name+'\t'+type+'\t'+num+'\t'+location+'\t'+date+'\t'+url)
            print('~~~~~~~~~~~')

            # yield item
            #请求详情页，二级流程
            yield scrapy.Request(url=url,callback=self.parse_detail,meta={'data':item})

    def parse_detail(self,response):
        # print('~~~~~~~~~~~detail~~~~~~~~~~~~`')
        # print(response.text)
        item=response.meta['data']
        with open('detail.html','w',encoding='utf-8') as f:
            f.write(response.body.decode('utf-8'))
        #工作职责
        duty=response.xpath('//tr[@class="c"][1]//li/text()').extract()
        # print(duty)#字符串列表
        duty=''.join(duty)
        item['duty'] = duty
        #工作要求
        rq=response.xpath('//tr[@class="c"][2]//li/text()').extract()
        rq=''.join(rq)
        item['rq']=rq
        print(duty+'\n')
        print(rq)
        print('~~~~~~~~~~~~~~~`')
        yield item
```


# [Scrapy翻页(样例)](https://www.jianshu.com/p/e66dfb5e6baa)

```python
class MusicspiderSpider(scrapy.Spider):
    name = 'musicspider'#爬虫识别名称
    allowed_domains = ['www.htqyy.com']#爬虫能够爬取的网址范围
    start_urls = ['http://www.htqyy.com/top/musicList/hot?pageIndex=0&pageSize=20']#爬取的起始url

    def parse(self, response):
        # filename='music.html'
        data= response.body.decode()#获取响应内容
        # open(filename,'wb').write(data)#写入本地，请求的动作被框架完成
        items=[]# 存放音乐信息的列表
        titles = re.findall(r'target="play" title="(.*?)"',data)#获取所有歌曲名
        artists = re.findall(r'target="_blank">(.*?)</a>', data)#获取所有艺术家

        for i in range(0,len(titles)):
            item=MyspiderItem()
            item["title"]=titles[i]
            item["artist"] = artists[i]
            yield item
        #获取当前请求的url，提取页码信息
        beforeurl=response.url
        pat1=r"pageIndex=(\d)"
        page=re.search(pat1,beforeurl).group(1)
        page=int(page)+1#获取下一页请求的page信息
        if page < 5:
        #构造下一页的url，发送下次请求
            nexturl='http://www.htqyy.com/top/musicList/hot?pageIndex='+str(page)+'&pageSize=20'
            #在parse方法中发送请求，请求完成后调用parse方法。
            yield scrapy.Request(nexturl,callback=self.parse)

```


# ClassLoader

```java
import java.io.File;
import java.io.FileFilter;
import java.io.IOException;
import java.net.JarURLConnection;
import java.net.URL;
import java.net.URLDecoder;
import java.util.Enumeration;
import java.util.HashSet;
import java.util.Set;
import java.util.jar.JarEntry;
import java.util.jar.JarFile;

public class ClassUtil {

    /**
     * 字符串check
     */
    private static boolean isNotBlank(String path) {
        return path != null && path.length() != 0;
    }

    /**
     * 添加到set
     */
    private static void doAddClass(Set<Class<?>> classSet, String className) {
        Class<?> cls = loadClass(className, false);
        classSet.add(cls);
    }

    /**
     * 添加文件到SET集合
     */
    private static void addClass(Set<Class<?>> classSet, String packagePath, String packageName) {
        File[] files = new File(packagePath).listFiles(new FileFilter() {
            @Override
            public boolean accept(File file) {
                return (file.isFile() && file.getName().endsWith(".class") || file.isDirectory());
            }
        });
        if (files == null)
            return;
        for (File file : files) {
            String fileName = file.getName();
            if (file.isFile()) {
                String className = fileName.substring(0, fileName.lastIndexOf("."));
                if (isNotBlank(packageName))
                    className = packageName + "." + className;
                doAddClass(classSet, className);
            } else {
                String subPackagePath = fileName;
                if (isNotBlank(packagePath))
                    subPackagePath = packagePath + "/" + subPackagePath;
                String subPackageName = fileName;
                if (isNotBlank(packageName))
                    subPackageName = packageName + "." + subPackageName;
                addClass(classSet, subPackagePath, subPackageName);
            }
        }
    }

    /**
     * 获取类加载器
     */
    public static ClassLoader getClassLoader() {
        return Thread.currentThread().getContextClassLoader();
    }

    /**
     * 加载类
     * 需要提供类名与是否初始化的标志，
     * 初始化是指是否执行静态代码块
     */
    public static Class<?> loadClass(String className, boolean isInitialized) {
        Class<?> cls;
        try {
            cls = Class.forName(className, isInitialized, getClassLoader());
        } catch (ClassNotFoundException e) {
            throw new RuntimeException(e);
        }
        return cls;
    }

    /**
     * 加载类（默认将初始化类）
     */
    public static Class<?> loadClass(String className) {
        return loadClass(className, true);
    }

    /**
     * 加载指定包下的所有类
     */
    public static Set<Class<?>> getClassSet(String packageName) throws IOException {
        Set<Class<?>> classSet = new HashSet<>();
        Enumeration<URL> urls = getClassLoader().getResources(packageName.replace(".", "/"));
        while (urls.hasMoreElements()) {
            URL url = urls.nextElement();
            if (url != null) {
                String protocol = url.getProtocol();
                if (protocol.equals("file")) {
                    // 转码
                    String packagePath = URLDecoder.decode(url.getFile(), "UTF-8");
                    addClass(classSet, packagePath, packageName);
                } else if (protocol.equals("jar")) {
                    JarURLConnection jarURLConnection = (JarURLConnection) url.openConnection();
                    if (jarURLConnection != null) {
                        JarFile jarFile = jarURLConnection.getJarFile();
                        if (jarFile != null) {
                            Enumeration<JarEntry> jarEntries = jarFile.entries();
                            while (jarEntries.hasMoreElements()) {
                                JarEntry jarEntry = jarEntries.nextElement();
                                String jarEntryName = jarEntry.getName();
                                if (jarEntryName.endsWith(".class")) {
                                    String className = jarEntryName.substring(0, jarEntryName.lastIndexOf("."))
                                            .replaceAll("/", ".");
                                    doAddClass(classSet, className);
                                }
                            }
                        }
                    }
                }
            }
        }
        return classSet;
    }
}
```


# log4j配置

```java
String homeDir = System.getenv("SYSTEM_HOME");
if (homeDir == null || "".equals(homeDir)) {
    homeDir = System.getProperty("user.dir");
}
Properties resource = new Properties();
try (InputStream in = new FileInputStream(homeDir + "/conf/log4j.properties");) {
    resource.load(in);
} catch (IOException e) {
    e.printStackTrace();
}
PropertyConfigurator.configure(resource);
```


# 包扫描

```java
import java.io.File;
import java.io.IOException;
import java.net.JarURLConnection;
import java.net.URL;
import java.net.URLDecoder;
import java.util.ArrayList;
import java.util.Enumeration;
import java.util.List;
import java.util.jar.JarEntry;
import java.util.jar.JarFile;
import java.util.stream.Stream;

@SuppressWarnings("unused")
public class HQScanPackage {
    /**
     * ClassLoader
     */
    private final ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
    /**
     * 包名集合
     */
    private final List<String> packageNames = new ArrayList<>();
    /**
     * 是否循环迭代
     */
    boolean recursive = true;
    /**
     * 过滤器
     */
    private HQScanPackageFilter filter;
    /**
     * 监听器
     */
    private HQScanPackageListener listener;


    public static void main(String[] args) {
        // 创建结果集
        List<Class<?>> objects = new ArrayList<>();
        // 实例化
        new HQScanPackage()
                // 添加待扫描包
                .addPackage(HQScanPackage.class.getPackage().getName())
                // 设置过滤器
                .setFilter(clazz -> true)
                // 设置监听器使结果添加到结果集
                .setListener(objects::add)
                // 执行扫描
                .scan();
        objects.forEach(System.out::println);
    }

    /**
     * 是否循环迭代
     */
    public boolean isRecursive() {
        return recursive;
    }

    /**
     * 设置是否循环迭代
     */
    public void setRecursive(boolean recursive) {
        this.recursive = recursive;
    }

    /**
     * 获得过滤器
     */
    public HQScanPackageFilter getFilter() {
        return filter;
    }

    /**
     * 设置过滤器
     */
    public HQScanPackage setFilter(HQScanPackageFilter filter) {
        this.filter = filter;
        return this;
    }

    /**
     * 获得监听器
     */
    public HQScanPackageListener getListener() {
        return listener;
    }

    /**
     * 设置监听器
     */
    public HQScanPackage setListener(HQScanPackageListener listener) {
        this.listener = listener;
        return this;
    }

    /**
     * 添加扫描包
     */
    public HQScanPackage addPackage(String packageName) {
        if (packageName == null || !packageName.matches("[\\w]+(\\.[\\w]+)*")) {
            throw new IllegalArgumentException("非法包名.");
        }
        this.packageNames.add(packageName);
        return this;
    }

    /**
     * 清空扫描包
     */
    public void clearPackage() {
        this.packageNames.clear();
    }

    /**
     * 扫描所有包
     */
    public void scan() {
        for (String packageName : packageNames) {
            scan(packageName);
        }
    }

    /**
     * 是否接受
     */
    private boolean accept(Class<?> clazz) {
        if (this.filter != null) {
            return this.filter.accept(clazz);
        }
        return true;
    }

    /**
     * 触发扫描到合法类
     */
    private void triggerOnScanClass(Class<?> clazz) {
        if (this.listener != null) {
            this.listener.onScanClass(clazz);
        }
    }

    /**
     * 扫描到类
     */
    private void onScanClass(Class<?> clazz) {
        if (accept(clazz)) {
            triggerOnScanClass(clazz);
        }
    }

    /**
     * 从包package中获取所有的Class
     *
     * @param packageName 包名
     */
    private void scan(String packageName) {
        // 获取包的名字 并进行替换
        String packageDirName = packageName.replace('.', '/');
        // 定义一个枚举的集合 并进行循环来处理这个目录下的things
        Enumeration<URL> dirs;
        try {

            dirs = this.classLoader.getResources(packageDirName);
            // 循环迭代下去
            while (dirs.hasMoreElements()) {
                // 获取下一个元素
                URL url = dirs.nextElement();
                // 得到协议的名称
                String protocol = url.getProtocol();
                // 如果是以文件的形式保存在服务器上
                if ("file".equals(protocol)) {
                    // 获取包的物理路径
                    String filePath = URLDecoder.decode(url.getFile(), "UTF-8");
                    // 以文件的方式扫描整个包下的文件 并添加到集合中
                    findAndAddClassesInPackageByFile(packageName, filePath);
                } else if ("jar".equals(protocol)) {
                    // 如果是jar包文件
                    // 定义一个JarFile
                    JarFile jar;
                    try {
                        // 获取jar
                        jar = ((JarURLConnection) url.openConnection()).getJarFile();
                        // 从此jar包 得到一个枚举类
                        Enumeration<JarEntry> entries = jar.entries();
                        // 同样的进行循环迭代
                        while (entries.hasMoreElements()) {
                            // 获取jar里的一个实体 可以是目录 和一些jar包里的其他文件 如META-INF等文件
                            JarEntry entry = entries.nextElement();
                            String name = entry.getName();
                            // 如果是以/开头的
                            if (name.charAt(0) == '/') {
                                // 获取后面的字符串
                                name = name.substring(1);
                            }
                            // 如果前半部分和定义的包名相同
                            if (name.startsWith(packageDirName)) {
                                int idx = name.lastIndexOf('/');
                                // 如果以"/"结尾 是一个包
                                if (idx != -1) {
                                    // 获取包名 把"/"替换成"."
                                    packageName = name.substring(0, idx).replace('/',
                                            '.');
                                }
                                // 如果可以迭代下去 并且是一个包
                                if ((idx != -1) || recursive) {
                                    // 如果是一个.class文件 而且不是目录
                                    if (name.endsWith(".class") && !entry.isDirectory()) {
                                        // 去掉后面的".class" 获取真正的类名
                                        String className = name.substring(
                                                packageName.length() + 1,
                                                name.length() - 6);
                                        try {
                                            // 添加到classes
                                            // 使用Class.forName会触发类静态方法
                                            Class<?> clazz = Thread.currentThread()
                                                    .getContextClassLoader().loadClass(
                                                            packageName + '.' + className);
                                            onScanClass(clazz);
                                        } catch (ClassNotFoundException e) {
                                            System.err.println("加载类出错");
                                        }
                                    }
                                }
                            }
                        }
                    } catch (IOException e) {
                        System.err.println("在扫描用户定义视图时从jar包获取文件出错");
                        e.printStackTrace();
                    }
                }
            }
        } catch (IOException e) {
            System.err.println("扫描出错");
            e.printStackTrace();
        }
    }

    /**
     * 以文件的形式来获取包下的所有Class
     *
     * @param packageName 包名
     * @param packagePath 包路径
     */
    private void findAndAddClassesInPackageByFile(String packageName, String packagePath) {
        // 获取此包的目录 建立一个File
        File dir = new File(packagePath);
        // 如果不存在或者 也不是目录就直接返回
        if (!dir.exists() || !dir.isDirectory()) {
            System.err.println("用户定义包名 " + packageName + " 下没有任何文件");
            return;
        }
        // 如果存在 就获取包下的所有文件 包括目录
        // 自定义过滤规则 如果可以循环(包含子目录) 或则是以.class结尾的文件(编译好的java类文件)
        File[] dirFiles = dir.listFiles(file -> (recursive && file.isDirectory()) || (file.getName().endsWith(".class")));
        // 循环所有文件
        if (dirFiles == null) return;
        for (File file : dirFiles) {
            // 如果是目录 则继续扫描
            if (file.isDirectory()) {
                findAndAddClassesInPackageByFile(packageName + "." + file.getName(), file.getAbsolutePath());
            } else {
                // 如果是java类文件 去掉后面的.class 只留下类名
                String className = file.getName().substring(0, file.getName().length() - 6);
                try {
                    Class<?> clazz = this.classLoader.loadClass(packageName + '.' + className);
                    onScanClass(clazz);
                } catch (ClassNotFoundException e) {
                    System.err.println("添加用户自定义视图类错误 找不到此类的.class文件");
                    e.printStackTrace();
                }
            }
        }
    }

    /**
     * 扫描包过滤器
     */
    @FunctionalInterface
    public interface HQScanPackageFilter {
        boolean accept(Class<?> clazz);
    }

    /**
     * 扫描包监听
     */
    @FunctionalInterface
    public interface HQScanPackageListener {
        void onScanClass(Class<?> clazz);
    }
}
```


# ssh轮询
## 发送指令

```shell
#!/bin/bash

cmd="$@"
host_list=~/host_list

for host in `cat ${host_list}`
do
        echo -e "\033[33m==========${host}==========\033[0m"
        ssh ${host} -oStrictHostKeyChecking=no ${cmd}
        if [[ $? -eq 0 ]];then
                echo -e "\033[36mSuccess\033[0m"
        else
                echo -e "\033[31mFailed\033[0m"
        fi
done
```


## rsync发送文件

```shell
#!/bin/bash

set -e

basedir=`readlink -f $1 | xargs dirname`
host_list=~/host_list

while read host
do
        echo -e "\033[33m==========${host}==========\033[0m"
        rsync -acvhz -e "ssh -o PubkeyAuthentication=yes -o stricthostkeychecking=no" `readlink -f $@` ${host}:${basedir}
done < ${host_list}
```


## 并发发送命令

```shell
#!/bin/bash
start=`date +%s`

cmd="$@"
host_list=~/host_list

for host in `cat ${host_list}`
do
{
        ssh ${host} -oStrictHostKeyChecking=no ${cmd} > /dev/null
        if [[ $? -eq 0 ]];then
                echo -e "\033[36m${host} Success\033[0m"
        else
                echo -e "\033[31m${host} Failed\033[0m"
        fi
}&
done
wait
end=`date +%s`

echo "TIME:`expr $end - $start`"
```


```{.python .input}
# jupyter 起停脚本
```shell
#!/bin/bash

res=$(ps -ef | grep -v grep | grep "/usr/bin/python3 /usr/local/bin/jupyter-lab")
ts=$(date +%Y%m%d%H%M%S)
log_path="${HOME}/log"
case $1 in
on)
        if [[ -z ${res} ]];then
                ls ${log_path} > /dev/null 2>&1 || mkdir -p ${log_path} > /dev/null 2>&1
                if [[ $? -ne 0 ]];then
                        echo "Unable to create log file. No log will be generated in this run."
                        nohup jupyter-lab > /dev/null 2>&1 &
                else
                        nohup jupyter-lab > ~/log/jpy_${ts}.log 2>&1 &
                fi
        fi
        echo 'jupyterlab started'
;;
off)
        if [[ -n ${res} ]];then
                echo ${res} | xargs echo | cut -d" " -f2 | xargs kill
        fi
        echo 'jupyterlab stopped'
;;
*)
        if [[ -z ${res} ]];then
                echo 'jupyterlab not running'
        else
                echo ${res}
        fi
;;
esac
```
```
