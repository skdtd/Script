<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate" />
    <title>颜色设置</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            /* border: 0; */
        }
    </style>
</head>

<body>
    <div>
        <table style="text-align: center;" id="colors">
            <tr>
                <th>方向</th>
                <th>字体颜色</th>
                <th>字体背景</th>
            </tr>
            <tr id="LU">
                <td>上左</td>
                <td><input type="color"></td>
                <td><input type="color"></td>
            </tr>
            <tr id="MU">
                <td>上中</td>
                <td><input type="color"></td>
                <td><input type="color"></td>
            </tr>
            <tr id="RU">
                <td>上右</td>
                <td><input type="color"></td>
                <td><input type="color"></td>
            </tr>
            <tr id="LD">
                <td>下左</td>
                <td><input type="color"></td>
                <td><input type="color"></td>
            </tr>
            <tr id="MD">
                <td>下中</td>
                <td><input type="color"></td>
                <td><input type="color"></td>
            </tr>
            <tr id="RD">
                <td>下右</td>
                <td><input type="color"></td>
                <td><input type="color"></td>
            </tr>
        </table>
    </div>
    <hr>
    <div>
        <table class="setting">
            <tr>
                <td>字体大小</td>
                <td><input id="font_size" min=1 max=100 step=1 value=22 type="number"></td>
            </tr>
            <tr>
                <td>单元格宽度</td>
                <td><input id="cell_width" min=1 max=300 step=1 value=110 type="number"></td>
            </tr>
            <tr>
                <td>行数</td>
                <td><input id="row_num" min=1 max=20 step=1 value=20 type="number"></td>
            </tr>
            <tr>
                <td>列数</td>
                <td><input id="col_num" min=1 max=10 step=1 value=6 type="number"></td>
            </tr>
            <tr>
                <td>刷新速度</td>
                <td><input id="fresh_speed" min=1 max=10 step=1 value=5 type="number"></td>
            </tr>
        </table>
    </div>
    <hr>
    <div>
        <table class="setting">
            <tr>
                <td>文字显示</td>
                <td><input id="ad_text" type="text"></td>
            </tr>
            <tr>
                <td>文字大小</td>
                <td><input id="ad_size" min=1 max=100 step=1 value=22 type="number"></td>
            </tr>
            <tr>
                <td>文字颜色</td>
                <td><input id="ad_font" type="color"></td>
            </tr>
            <tr>
                <td>文字背景颜色</td>
                <td><input id="ad_bg" type="color"></td>
            </tr>
        </table>
    </div>
    <hr>
    <div>
        <table class="setting">
            <tr>
                <td>侧边图片</td>
                <td><input id="ad_pic" type="file"></td>
            </tr>
            <tr>
                <td>图片大小</td>
                <td><input id="ad_pic_size" type="number"></td>
            </tr>
        </table>
    </div>
    <hr>
    <div>
        <table class="setting">
            <tr>
                <td>水印图片</td>
                <td><input id="bg_img" type="file"></td>
            </tr>
            <tr>
                <td>水印图片大小</td>
                <td><input id="bg_img_size" min=1 max=100 step=1 value=100 type="number"></td>
            </tr>
        </table>
    </div>
    <hr>
    <div id="pre"></div>
</body>
<script>
    var server_ip = 'localhost'
    var server_port = 8899
    function ajax_method(url, data, method, success, async) {
        var ajax = new XMLHttpRequest()
        url = 'http://' + server_ip + ':' + server_port + '/' + url
        ajax.open(method, url, async)
        ajax.onreadystatechange = function () {
            if (ajax.readyState == 4 && ajax.status == 200) {
                if (success) {
                    success(ajax.responseText)
                }
            } else {
                // nothing todo
            }
        }
        if (method.toUpperCase() == 'GET') {
            if (data) {
                url += '?'
                url += data
            }
            ajax.send()
        } else if (method.toUpperCase() == 'POST') {
            if (data.constructor.name != 'FormData'){
                ajax.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
            }
            if (data) {
                ajax.send(data)
            } else {
                ajax.send()
            }
        } else {
            console.log('Unsupported method')
        }
    }

    function init_setting() {
        var elms = document.getElementsByClassName('setting')
        var ids = []
        for (var i = 0; i < elms.length; i++) {
            var inputs = elms[i].getElementsByTagName('input')
            for (let i = 0; i < inputs.length; i++) {
                ids.push(inputs[i].id)
            }
        }
        var url = 'setting?key=' + ids.join('&key=')
        ajax_method(url, null, 'GET', (resp) => {
            var obj = JSON.parse(resp)
            for (i in ids) {
                var input = document.getElementById(ids[i])
                input.value = obj[input.id] ? obj[input.id] : ''
                input.onchange = (e) => {
                    var url = 'setting'
                    if (e.target.type == 'file') {
                        // 文件形式
                        var form = new FormData()
                        form.append("file", e.target.files[0])
                        form.append("key", e.target.id)
                        ajax_method(url, form, 'POST')
                    } else {
                        // 字符形式
                        var data = 'key=' + e.target.id + '&value=' + e.target.value
                        ajax_method(url, data, 'POST')
                    }
                }
            }
        })

    }
    init_setting()
    function init_colors() {
        // 为每个input添加默认选中值
        // 同步请求从服务器获取之前保存的颜色,加载为预显示颜色
        ajax_method('color', null, 'GET', (resp) => {
            var obj = JSON.parse(resp)
            for (idx in obj) {
                var elm = document.getElementById(obj[idx][0])
                var inputs = elm.getElementsByTagName('input')
                inputs[0].value = obj[idx][1]
                inputs[1].value = obj[idx][2]
            }
        })

        // 为colors中的每个input添加事件
        var colors = document.getElementById('colors')
        var inputs = colors.getElementsByTagName('input')
        for (let i = 0; i < inputs.length; i++) {
            inputs[i].onchange = () => {
                // 数值修改时向服务器发起异步请求
                var tr = document.getElementById(inputs[i].parentElement.parentElement.id)
                var ins = tr.getElementsByTagName('input')
                var data = 'alias=' + inputs[i].parentElement.parentElement.id + "&font=" + ins[0].value + "&bg=" + ins[1].value
                ajax_method('color', data, 'POST', null)
            }
        }
    }
    init_colors()
</script>

</html>