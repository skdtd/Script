<!DOCTYPE html>
<html lang="en" id="drop_zone">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate" />
    <title>展示页</title>
    <style>
        *{
            margin: 0;
            padding: 0;
            border: 0;
        }
        table{
            Border-spacing: 0;
        }
        td, th{
            border: 1px solid;
            text-align: center;
            width: 110px;
        }
    </style>
</head>
<body>
    <div>
        <table id="data_conut"></table>
        <table id="data_table"></table>
    </div>
    <div id="ad"></div>
    <img id="pic" style="position: absolute; top: 70px; left: 790px"/>
</body>

<script>
    var DEFAULT = {
        'font_size'     :22,
        'cell_width'    :110,
        'row_num'       :20,
        'col_num'       :6,
        'fresh_speed'   :5,
        'ad_text'       :'',
        'ad_size'       :'',
        'ad_font'       :'',
        'ad_bg'         :'',
        'ad_pic_size'   :'',
        'bg_img_size'   :''
    }
    var DIRE = {
        'LU': '左上',
        'MU': '中上',
        'RU': '右上',
        'LD': '左下',
        'MD': '中下',
        'RD': '右下'
    }
    var OFF_PROB = {
        'LU': '32.00%',
        'MU': '32.00%',
        'RU': '20.00%',
        'LD': '7.00%',
        'MD': '5.00%',
        'RD': '4.00%'
    }

    var server_ip = '49.235.109.183'
    // var server_ip = 'localhost'
    var server_port = 8899
    function ajax_method(url, data, method, success, async) {
        var ajax = new XMLHttpRequest()
        url = 'http://' + server_ip + ':' + server_port + '/' + url
        ajax.open(method, url, async)
        ajax.onreadystatechange = function () {
            if (ajax.readyState == 4 && ajax.status == 200) {
                if (success){
                    success(ajax.responseText)
                }
            } else {
                // nothing todo
            }
        }
        if (method.toUpperCase() == 'GET') {
            if (data) {
                url += '?'
                url += data
            }
            ajax.send()
        } else if (method.toUpperCase() == 'POST'){
            ajax.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
            if (data) {
                ajax.send(data)
            } else {
                ajax.send()
            }
        } else {
            console.log('Unsupported method')
        }
    }
    
    // 获取配置信息保存到全局
    var settings
    ajax_method('setting', null, 'GET', (resp) =>{
        settings = JSON.parse(resp)
    })
    // var bg
    // drop_zone.ondragover = (e) => {e.preventDefault()}
    // drop_zone.ondrop = (e) => {
    //     e.preventDefault()
    //     file = e.dataTransfer.files[0]
    //     var reader = new FileReader();
    //     reader.readAsDataURL(file);
    //     reader.onload = function () { 
    //         drop_zone.style = bg = "background: url('" + this.result + "');background-size: " + bg_size.value + "%;"
    //     }
    // }
    // function setBackground(){
    //     drop_zone.style = bg + 'background-size: ' + bg_size.value + '%;'
    // }
    // 更新表
    function updata_table(){
        var row = settings['row_num'] ? settings['row_num'] : 20
        var col = settings['col_num'] ? settings['col_num'] : 6
        // 获取数据(统计栏)
        var date = new Date().toLocaleDateString()
        var url = 'count?date=' + date
        ajax_method(url, null, 'GET', (resp) => {
            var obj = JSON.parse(resp)
            var tr_header = document.createElement('tr') // 表头
            var tr_current = document.createElement('tr') // 当前概率
            var tr_official = document.createElement('tr') // 官方概率
            var th_sum = document.createElement('th') // 表头总数
            var th_current = document.createElement('th') // 表头当前概率
            var th_official = document.createElement('th') // 表头官方概率
            tr_header.append(th_sum)
            tr_current.append(th_current)
            tr_official.append(th_official)
            var sum = 0;
            // 添加表头数据
            for (idx in DIRE){
                var th = document.createElement('th')
                var num = obj[idx] ? obj[idx][0] : 0
                var font = obj[idx] ? obj[idx][1] : ''
                var bg = obj[idx] ? obj[idx][2] : ''
                th.innerHTML = DIRE[idx] + ':' + num
                th.style = 'color: ' + font + '; background: ' + bg + ';'
                sum = sum + num
                tr_header.append(th)
            }
            // 添加当前概率
            for (idx in DIRE){
                var td = document.createElement('td')
                var n = obj[idx] ? obj[idx][0] : 0
                td.innerHTML = (n / sum * 100).toFixed(2) + '%'
                tr_current.append(td)
                var td = document.createElement('td')
                td.innerHTML = OFF_PROB[idx]
                tr_official.append(td)
            }
            th_sum.innerHTML = '总数:' + sum
            th_current.innerHTML = '当前概率'
            th_official.innerHTML = '官方概率'
            data_conut.innerHTML = ''
            data_conut.append(tr_header)
            data_conut.append(tr_current)
            data_conut.append(tr_official)
            // 添加该官方概率
            var tr = document.createElement('tr')
            for (var i = 0; i < obj.length; i++) {
                var td = document.createElement('td')
                td.innerHTML=DIRE[obj[i][0]] + '</br>' +  (obj[i][1] * 100).toFixed(2) + "%"
                tr.append(td)
            }
            data_conut.append(tr)
        })
        // 获取数据(数据栏)
        var url = 'pull?date=' + date + '&limit=' + row * col
        ajax_method(url, null, 'GET', (resp) => {
            var obj = JSON.parse(resp)
            var row = settings['row_num'] ? settings['row_num'] : 20
            var col = settings['col_num'] ? settings['col_num'] : 6
            var start = row - obj[obj.length - 1][0] % row
            if (start != row && obj.length > start) {
                for (var i = 0; i < start; i++) {
                    obj.shift()
                }
            }
            var ls = []
            for (idx in obj){
                if (ls[idx % row] == undefined) ls[idx % row] = []
                ls[idx % row].push(obj[idx])
            }
            // 更新页面
            data_table.innerHTML = ''
            for (var r = 0; r < row; r++){
                if (ls[r]){
                    var tr = document.createElement('tr')
                    for (var c = 0; c < col; c++){
                        if (ls[r][c]){
                            var td = document.createElement('td')
                            var b = document.createElement('b')
                            b.innerHTML = DIRE[ls[r][c][3]]
                            td.style = "color: " + ls[r][c][4] + "; background: " + ls[r][c][5] + ";"
                            td.innerHTML = ls[r][c][2]
                            td.appendChild(b)
                            tr.appendChild(td)
                        }
                    }
                    data_table.appendChild(tr)
                }
            }
        })
    }
    var timer
    function fresh(){
        if (timer){
            clearInterval(timer)
        }
        timer = setInterval(updata_table, (settings['fresh_speed'] ? settings['fresh_speed'] : DEFAULT['fresh_speed']) * 1000)
    }

    function init_ad(){
        // 添加文字广告
        var ad_text = settings['ad_text']
        var ad_size = settings['ad_size']
        var ad_font = settings['ad_font']
        var ad_bg = settings['ad_bg']
        // console.log(ad_text, ad_si[ze,ad_font , ad_bg)
        if (!ad_text) {
            return
        }
        ad.innerHTML = ""
        var p = document.createElement("p")
        p.innerHTML = ad_text
        p.style = 'max-width: 800px; color: ' + ad_font + '; background: ' + ad_bg + '; font-size:' + ad_size + 'px;'
        ad.appendChild(p)
        // 添加二维码
        console.log(pic)
        ajax_method('pic?pic=ad_pic', null, 'GET', (resp)=>{
            pic.src=resp
            pic.width = settings['ad_pic_size']
        })
    }
    updata_table()
    fresh()
    init_ad()
</script>

<script>
    var mask_div = document.createElement('div');
    mask_div.id = 'mask_div1';
    mask_div.style.position = "absolute";
    mask_div.style.left = '20px';
    mask_div.style.top = '20px';
    mask_div.style.overflow = "hidden";
    mask_div.style.zIndex = "9999";
    mask_div.style.opacity = 0.3;
    document.body.appendChild(mask_div);

    function watermark(settings) {
        //默认设置
        var defaultSettings = {
            watermark_txt: "text",
            watermark_x: 20,//水印起始位置x轴坐标
            watermark_y: 20,//水印起始位置Y轴坐标
            watermark_rows: 20,//水印行数
            watermark_cols: 20,//水印列数
            watermark_x_space: 0,//水印x轴间隔
            watermark_y_space: 0,//水印y轴间隔
            watermark_color: '#FF0000',//水印字体颜色
            watermark_alpha: 0.2,//水印透明度
            watermark_fontsize: '23px',//水印字体大小
            watermark_font: '微软雅黑',//水印字体
            watermark_width: 280,//水印宽度
            watermark_height: 120,//水印长度
            watermark_angle: 15//水印倾斜度数
        };
        //采用配置项替换默认值，作用类似jquery.extend
        if (arguments.length === 1 && typeof arguments[0] === "object") {
            var src = arguments[0] || {};
            for (key in src) {
                if (src[key] && defaultSettings[key] && src[key] === defaultSettings[key])
                    continue;
                else if (src[key])
                    defaultSettings[key] = src[key];
            }
        }

        var oTemp = document.createDocumentFragment();

        //获取页面最大宽度
        var page_width = Math.max(document.body.scrollWidth, document.body.clientWidth);
        //获取页面最大长度
        var page_height = Math.max(document.body.scrollHeight, document.body.clientHeight);

        //如果将水印列数设置为0，或水印列数设置过大，超过页面最大宽度，则重新计算水印列数和水印x轴间隔
        if (defaultSettings.watermark_cols == 0 || (parseInt(defaultSettings.watermark_x + defaultSettings.watermark_width * defaultSettings.watermark_cols + defaultSettings.watermark_x_space * (defaultSettings.watermark_cols - 1)) > page_width)) {
            defaultSettings.watermark_cols = parseInt((page_width - defaultSettings.watermark_x + defaultSettings.watermark_x_space) / (defaultSettings.watermark_width + defaultSettings.watermark_x_space));
            defaultSettings.watermark_x_space = parseInt((page_width - defaultSettings.watermark_x - defaultSettings.watermark_width * defaultSettings.watermark_cols) / (defaultSettings.watermark_cols - 1));
        }
        //如果将水印行数设置为0，或水印行数设置过大，超过页面最大长度，则重新计算水印行数和水印y轴间隔
        if (defaultSettings.watermark_rows == 0 || (parseInt(defaultSettings.watermark_y + defaultSettings.watermark_height * defaultSettings.watermark_rows + defaultSettings.watermark_y_space * (defaultSettings.watermark_rows - 1)) > page_height)) {
            defaultSettings.watermark_rows = parseInt((defaultSettings.watermark_y_space + page_height - defaultSettings.watermark_y) / (defaultSettings.watermark_height + defaultSettings.watermark_y_space));
            defaultSettings.watermark_y_space = parseInt(((page_height - defaultSettings.watermark_y) - defaultSettings.watermark_height * defaultSettings.watermark_rows) / (defaultSettings.watermark_rows - 1));
        }
        var x;
        var y;
        for (var i = 0; i < defaultSettings.watermark_rows; i++) {
            y = defaultSettings.watermark_y + (defaultSettings.watermark_y_space + defaultSettings.watermark_height) * i;
            for (var j = 0; j < defaultSettings.watermark_cols; j++) {
                x = defaultSettings.watermark_x + (defaultSettings.watermark_width + defaultSettings.watermark_x_space) * j;

                var mask_div = document.createElement('div');
                mask_div.id = 'mask_div' + i + j;
                mask_div.appendChild(document.createTextNode(defaultSettings.watermark_txt));
                //设置水印div倾斜显示
                mask_div.style.webkitTransform = "rotate(-" + defaultSettings.watermark_angle + "deg)";
                mask_div.style.MozTransform = "rotate(-" + defaultSettings.watermark_angle + "deg)";
                mask_div.style.msTransform = "rotate(-" + defaultSettings.watermark_angle + "deg)";
                mask_div.style.OTransform = "rotate(-" + defaultSettings.watermark_angle + "deg)";
                mask_div.style.transform = "rotate(-" + defaultSettings.watermark_angle + "deg)";
                mask_div.style.visibility = "";
                mask_div.style.position = "absolute";
                mask_div.style.left = x + 'px';
                mask_div.style.top = y + 'px';
                mask_div.style.overflow = "hidden";
                mask_div.style.zIndex = "9999";
                mask_div.style.opacity = defaultSettings.watermark_alpha;
                mask_div.style.fontSize = defaultSettings.watermark_fontsize;
                mask_div.style.fontFamily = defaultSettings.watermark_font;
                mask_div.style.color = defaultSettings.watermark_color;
                mask_div.style.textAlign = "center";
                mask_div.style.fontWeight = "bolder";
                mask_div.style.width = defaultSettings.watermark_width + 'px';
                mask_div.style.height = defaultSettings.watermark_height + 'px';
                mask_div.style.display = "block";
                mask_div.style.pointerEvents = "none"; //禁止水印被复制并防止遮挡【实体虚化】
                oTemp.appendChild(mask_div);
            };
        };
        document.body.appendChild(oTemp);
    }
    window.onload = function () {
        watermark({ watermark_txt: "宝藏猎人交流V: CB04878直播间号: 28025792" });
    };
</script>
</html>