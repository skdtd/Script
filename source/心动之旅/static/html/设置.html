<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <script src="{{ url_for('static',filename='js/common.js') }}"></script>
    <title>颜色设置</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
<div>
    <table style="text-align: center;" id="colors">
        <tr>
            <th>方向</th>
            <th>字体颜色</th>
            <th>字体背景</th>
            <th>官方概率</th>
        </tr>
        {% for item in items %}
        <tr id="{{item}}">
            <td>{{item}}</td>
            <td><input type="color"></td>
            <td><input type="color"></td>
            <td><input type="number" max="100" min="0" value="0">%</td>
        </tr>
        {% endfor %}
    </table>
</div>
<hr>
<div>
    <table class="setting">
        <tr>
            <td>文字显示</td>
            <td><input id="ad_text" type="text"></td>
        </tr>
        <tr>
            <td>文字大小</td>
            <td><input id="ad_size" min=1 max=100 step=1 value=22 type="number"></td>
        </tr>
        <tr>
            <td>文字颜色</td>
            <td><input id="ad_font" type="color"></td>
        </tr>
        <tr>
            <td>文字背景颜色</td>
            <td><input id="ad_bg" type="color"></td>
        </tr>
    </table>
</div>
<hr>
<div>
    <table class="setting">
        <tr>
            <td>侧边图片</td>
            <td><input id="ad_pic" type="file"></td>
        </tr>
        <tr>
            <td>图片距离页面最左边距离</td>
            <td><input id="ad_pic_x" type="number"></td>
        </tr>
        <tr>
            <td>图片距离页面最顶部距离</td>
            <td><input id="ad_pic_y" type="number"></td>
        </tr>
        <tr>
            <td>图片大小</td>
            <td><input id="ad_pic_size" max=1000 min=1 type="number"></td>
        </tr>
    </table>
</div>
<hr>
<div>
    <table class="setting">
        <tr>
            <td>行数</td>
            <td><input id="row_num" min=1 max=40 step=1 value=20 type="number"></td>
        </tr>
        <tr>
            <td>列数</td>
            <td><input id="col_num" min=1 max=20 step=1 value=6 type="number"></td>
        </tr>
    </table>
</div>
</body>
<script>
    settings = JSON.parse('{{settings|tojson}}')
    const url = "{{server}}/setting";
    // 为colors中的每个input添加事件
    const colors = document.getElementById('colors')
    const inputs = colors.getElementsByTagName('input')
    for (let i = 0; i < inputs.length; i++) {
        inputs[i].onchange = () => {
            // 数值修改时向服务器发起异步请求
            const tr = document.getElementById(inputs[i].parentElement.parentElement.id)
            const ins = tr.getElementsByTagName('input')
            const data = `key=${inputs[i].parentElement.parentElement.id}&value=${ins[0].value},${ins[1].value},${ins[2].value}`
            ajax_method(url, data, 'POST', null)
        }
    }

    // 同步请求从服务器获取之前保存的颜色,加载为预显示颜色
    for (const idx in settings) {
        const elm = document.getElementById(idx)
        if (!elm) {
            continue
        }
        if (elm.tagName === 'INPUT') {
            elm.value = settings[idx]
        } else {
            const inputs = elm.getElementsByTagName('input')
            const fb = settings[idx] ? settings[idx].split(',') : ["#000000", "#000000", 0]
            inputs[0].value = fb[0]
            inputs[1].value = fb[1]
            inputs[2].value = fb[2]
        }
    }

    // 获取页面上的所有配置项
    const elms = document.getElementsByClassName('setting');
    const ids = [];
    for (let i = 0; i < elms.length; i++) {
        const inputs = elms[i].getElementsByTagName('input');
        for (let i = 0; i < inputs.length; i++) {
            ids.push(inputs[i].id)
        }
    }


    // 初始化所有设置项
    for (const i in ids) {
        const input = document.getElementById(ids[i]);
        input.value = settings[input.id] ? settings[input.id] : ""
        input.onchange = (e) => {
            if (e.target.type === 'file') {
                // 文件形式
                const form = new FormData()
                form.append("file", e.target.files[0])
                form.append("key", e.target.id)
                ajax_method(url, form, 'POST')
            } else {
                // 字符形式
                const _max = parseInt(e.target.max)
                const _min = parseInt(e.target.min)
                const _value = parseInt(e.target.value)
                console.log(e.target.max)
                console.log(e.target.type)
                if (e.target.type === 'number') {
                    if (_value > _max) {
                        e.target.value = _max
                    } else if (_value < _min) {
                        e.target.value = _min
                    }
                }
                const data = 'key=' + e.target.id + '&value=' + e.target.value
                ajax_method(url, data, 'POST')
            }
        }
    }


</script>

</html>