<!DOCTYPE html>
<head>
    <title>修改数据</title>
    <style>
        td {
            white-space: nowrap;
        }
    </style>
</head>
<body>
<label>选择日期: </label>
<label for="date_set"></label><select id="date_set" onChange="loadXMLDoc()">
    <option value="-1" selected>--选择日期--</option>
</select><input type="button" value="保存" onclick="submit()">
</select><input type="button" value="删除" onclick="del()"><br/>
<table>
    <tr>
        <td>序号</td>
        <td><input type="text" id="xh"></td>
    </tr>
    <tr>
        <td>日期</td>
        <td><input type="date" id="rq"></td>
    </tr>
    <tr>
        <td>时间戳</td>
        <td><input type="time" id="sjc"></td>
    </tr>
    <tr>
        <td>结果</td>
        <td><select id="jg">
            <option>丛林</option>
            <option>孤岛</option>
            <option>峡谷</option>
            <option>沉船</option>
            <option>沙漠</option>
            <option>海底</option>
        </select></td>
    </tr>
</table>

<table border="1" align="left" cellspacing="0" cellpadding="0">
    <tbody id="container">
    </tbody>
</table>
<script>
    const server_ip = '124.222.214.146';
    // server_ip = "localhost"
    server_port = 8899

    SHENGXIAO = {
        "巴黎": "32%",
        "爱琴海": "6.4%",
        "威尼斯": "25%",
        "埃及": "20%",
        "冰岛": "12.5%",
        "马尔代夫": "4.1%"
    }

    function ajax_method(url, data, method, success, async) {
        var ajax = new XMLHttpRequest()
        url = 'http://' + server_ip + ':' + server_port + '/' + url
        ajax.open(method, url, async)
        ajax.onreadystatechange = function () {
            if (ajax.readyState == 4 && ajax.status == 200) {
                if (success) {
                    success(ajax.responseText)
                }
            } else {
                // nothing todo
            }
        }
        if (method.toUpperCase() == 'GET') {
            if (data) {
                url += '?'
                url += data
            }
            ajax.send()
        } else if (method.toUpperCase() == 'POST') {
            if (data.constructor.name != 'FormData') {
                ajax.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
            }
            if (data) {
                ajax.send(data)
            } else {
                ajax.send()
            }
        } else {
            console.log('Unsupported method')
        }
    }

    function del() {
        const date_set = document.querySelector('#date_set').value;
        const xh = document.querySelector('#xh').value;
        if (date_set === "-1") {
            return
        }
        if (xh === "") {
            alert("输入要添加或者要修改的序号")
            return
        }
        let xmlhttp;
        if (window.XMLHttpRequest) {
            //  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
            xmlhttp = new XMLHttpRequest();
        } else {
            // IE6, IE5 浏览器执行代码
            xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
                loadXMLDoc()
            }
        }
        const args = `xh=${xh}`
        xmlhttp.open("POST", "http://" + server_ip + ":8899/fix?" + args, true)
        xmlhttp.send()
    }

    function submit() {
        const date_set = document.querySelector('#date_set').value;
        const xh = document.querySelector('#xh').value;
        const rq = document.querySelector('#rq').value;
        const sjc = document.querySelector('#sjc').value;
        const jg = document.querySelector('#jg').value;
        console.log(date_set, xh, rq, sjc, jg)
        if (date_set === "-1") {
            return
        }
        if (xh === "") {
            alert("输入要添加或者要修改的序号")
            return
        }
        if (sjc === "") {
            alert("时间戳不可为空")
            return
        }
        let xmlhttp;
        if (window.XMLHttpRequest) {
            //  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
            xmlhttp = new XMLHttpRequest();
        } else {
            // IE6, IE5 浏览器执行代码
            xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
                loadXMLDoc()
            }
        }
        const args = `xh=${xh}&rq=${rq}&sjc=${sjc}&jg=${jg}`
        xmlhttp.open("POST", "http://" + server_ip + ":8899/fix?" + args, true)
        xmlhttp.send()
    }

    function loadXMLDoc() {
        if (date_set.value == '-1') {
            return
        }
        ajax_method("pull?date=" + date_set.value, null, 'GET', (resp) => {
            var container = document.querySelector('#container')
            container.innerHTML = ""
            var obj = JSON.parse(resp)
            table = document.createElement("table")
            tBody = document.createElement("tBody")
            _header = obj.count
            // 表头
            var tr_header = document.createElement('tr') // 表头
            var tr_current = document.createElement('tr') // 当前概率
            var tr_official = document.createElement('tr') // 官方概率
            var th_sum = document.createElement('th') // 表头总数
            var th_current = document.createElement('th') // 表头当前概率
            var th_official = document.createElement('th') // 表头官方概率
            th_current.style = th_sum.style = 'font-size: 16px; border-right: solid 1px;'
            th_official.style = 'font-size: 16px; border-right: solid 1px;border-bottom: solid 1px;'
            tr_header.append(th_sum)
            tr_current.append(th_current)
            tr_official.append(th_official)
            var sum = 0;
            // 添加表头数据
            for (idx in SHENGXIAO) {
                var th = document.createElement('th')
                var _num = _header[idx] ? _header[idx][0] : 0
                th.innerHTML = idx + ':' + _num
                sum = sum + _num
                if (_header[idx]) {
                    var _style = typeof (_header[idx][1]) == 'string' ? _header[idx][1].split(',') : ['#000000', '#FFFFFF']
                }
                th.style = "color: " + _style[0] + "; background: " + _style[1] + '; font-size: 16px; border-right: solid 1px #000000;'
                tr_header.append(th)
            }
            for (idx in SHENGXIAO) {
                // 添加当前概率
                var td = document.createElement('td')
                var n = _header[idx] ? _header[idx][0] : 0
                td.innerHTML = '-'
                if (sum != 0) {
                    td.innerHTML = (n / sum * 100).toFixed(1) + '%'
                }
                td.align = 'center'
                td.style = 'font-size: 16px; border-right: solid 1px;'
                tr_current.append(td)
                // 添加该官方概率
                var td = document.createElement('td')
                td.align = 'center'
                td.style = 'font-size: 16px; border-right: solid 1px; border-bottom: solid 1px;'
                td.innerHTML = SHENGXIAO[idx]
                tr_official.append(td)
            }
            th_sum.innerHTML = '总数:' + sum
            th_current.innerHTML = '当前概率'
            th_official.innerHTML = '官方概率'
            tBody.innerHTML = ''
            tBody.append(tr_header)
            tBody.append(tr_current)
            tBody.append(tr_official)
            table.appendChild(tBody)
            container.appendChild(table)

            // 添加数据区
            table = document.createElement("table")
            tBody = document.createElement("tBody")
            _data = obj.data
            console.log(_data)
            row = 20
            // 一维数组转二位数组
            var ls = []
            for (idx in _data) {
                if (ls[idx % row] == undefined) ls[idx % row] = []
                ls[idx % row].push(_data[idx])
            }
            // 开始渲染
            table_data = document.createElement("table")
            tBody_data = document.createElement("tBody")
            tBody_data.innerHTML = ''
            for (var r = 0; r < row; r++) {
                if (ls[r]) {
                    var tr = document.createElement('tr')
                    for (var c = 0; c < ls[0].length; c++) {
                        if (ls[r][c]) {
                            var td1 = document.createElement('td')
                            var td2 = document.createElement('td')
                            td1.innerHTML = ls[r][c][0] + "| " + ls[r][c][2]
                            td2.innerHTML = "<b>" + ls[r][c][3] + '</b>'
                            td1.align = "center"
                            td2.align = "center"
                            fb = ls[r][c][1] ? ls[r][c][1].split(',') : ["", ""]
                            td2.style = "color: " + fb[0] + ";background: " + fb[1] + ";border-right: solid 1px #000000;"
                            tr.appendChild(td1)
                            tr.appendChild(td2)
                        }
                    }
                    tBody_data.appendChild(tr)
                }
            }

            table_data.appendChild(tBody_data)
            table_data.style = "font-size: 16"
            container.appendChild(table_data)

        })
    }

    function update_date() {
        if (server_ip === "-1") {
            return
        }
        let xmlhttp;
        if (window.XMLHttpRequest) {
            //  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
            xmlhttp = new XMLHttpRequest();
        } else {
            // IE6, IE5 浏览器执行代码
            xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
        xmlhttp.onreadystatechange = function () {
            let opt;
            let ls;
            if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
                const container = document.querySelector('#date_set');
                container.innerHTML = "<option value='-1' selected>--选择日期--</option>"
                //把后台获取到的数据student渲染到页面
                ls = JSON.parse(xmlhttp.responseText)
                for (const idx in ls) {
                    opt = document.createElement("option")
                    opt.value = ls[idx]
                    opt.innerHTML = ls[idx]
                    container.append(opt)
                }
            }
        }
        xmlhttp.open("GET", "http://" + server_ip + ":8899/select_date", true);
        xmlhttp.send();
    }

    function init() {
        const _date = new Date;
        document.querySelector('#rq').valueAsDate = _date;
        document.querySelector('#sjc').value = _date.getHours() + ":" + _date.getMinutes()
    }

    update_date()
    init()
</script>
</body>
</html>