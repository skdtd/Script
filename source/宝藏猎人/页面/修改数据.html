<!DOCTYPE html>
<head>
    <title>修改数据</title>
    <style>
        td {
            white-space: nowrap;
        }
    </style>
</head>
<body>
<label>选择日期: </label>
<label for="date_set"></label><select id="date_set" onChange="loadXMLDoc()">
    <option value="-1" selected>--选择日期--</option>
</select><input type="button" value="保存" onclick="submit()">
</select><input type="button" value="删除" onclick="del()"><br/>
<table>
    <tr>
        <td>序号</td>
        <td><input type="text" id="xh"></td>
    </tr>
    <tr>
        <td>日期</td>
        <td><input type="date" id="rq"></td>
    </tr>
    <tr>
        <td>时间戳</td>
        <td><input type="time" id="sjc"></td>
    </tr>
    <tr>
        <td>结果</td>
        <td><select id="jg">
            <option>丛林</option>
            <option>孤岛</option>
            <option>峡谷</option>
            <option>沉船</option>
            <option>沙漠</option>
            <option>海底</option>
        </select></td>
    </tr>
</table>

<table border="1" align="left" cellspacing="0" cellpadding="0">
    <tbody id="container">
    </tbody>
</table>
<script>
    server_ip = "121.4.27.170"
    // server_ip = "localhost"

    function del() {
        const date_set = document.querySelector('#date_set').value;
        const xh = document.querySelector('#xh').value;
        if (date_set === "-1") {
            return
        }
        if (xh === "") {
            alert("输入要添加或者要修改的序号")
            return
        }
        let xmlhttp;
        if (window.XMLHttpRequest) {
            //  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
            xmlhttp = new XMLHttpRequest();
        } else {
            // IE6, IE5 浏览器执行代码
            xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
                loadXMLDoc()
            }
        }
        const args = `xh=${xh}`
        xmlhttp.open("POST", "http://" + server_ip + ":8899/fix?" + args, true)
        xmlhttp.send()
    }

    function submit() {
        const date_set = document.querySelector('#date_set').value;
        const xh = document.querySelector('#xh').value;
        const rq = document.querySelector('#rq').value;
        const sjc = document.querySelector('#sjc').value;
        const jg = document.querySelector('#jg').value;
        console.log(date_set, xh, rq, sjc, jg)
        if (date_set === "-1") {
            return
        }
        if (xh === "") {
            alert("输入要添加或者要修改的序号")
            return
        }
        if (sjc === "") {
            alert("时间戳不可为空")
            return
        }
        let xmlhttp;
        if (window.XMLHttpRequest) {
            //  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
            xmlhttp = new XMLHttpRequest();
        } else {
            // IE6, IE5 浏览器执行代码
            xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
                loadXMLDoc()
            }
        }
        const args = `xh=${xh}&rq=${rq}&sjc=${sjc}&jg=${jg}`
        xmlhttp.open("POST", "http://" + server_ip + ":8899/fix?" + args, true)
        xmlhttp.send()
    }

    function loadXMLDoc() {
        const date_set = document.querySelector('#date_set').value;
        if (date_set === "-1" || server_ip === "-1") {
            return
        }
        let xmlhttp;
        if (window.XMLHttpRequest) {
            //  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
            xmlhttp = new XMLHttpRequest();
        } else {
            // IE6, IE5 浏览器执行代码
            xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
        xmlhttp.onreadystatechange = function () {
            var resCell;
            if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
                const container = document.querySelector('#container');
                container.innerHTML = ""
                const obj = JSON.parse(xmlhttp.responseText);
                table = document.createElement("table")
                tBody = document.createElement("tBody")
                for (const outter in obj.data) {
                    tr = tBody.insertRow()
                    for (const inner in obj.data[outter]) {
                        tr.insertCell().innerHTML = "<b>" + obj.data[outter][inner]['id'] + "</b>"
                        tr.insertCell().innerHTML = obj.data[outter][inner]['time_stamp']
                        resCell = tr.insertCell()
                        resCell.style = "border-right: solid 1px"
                        resCell.innerHTML = obj.data[outter][inner]['result']
                    }
                }

                table.appendChild(tBody)
                container.appendChild(table)
            }
        }
        xmlhttp.open("GET", "http://" + server_ip + ":8899/select_by_date?date=" + date_set, true)
        xmlhttp.send()
    }

    function update_date() {
        if (server_ip === "-1") {
            return
        }
        let xmlhttp;
        if (window.XMLHttpRequest) {
            //  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
            xmlhttp = new XMLHttpRequest();
        } else {
            // IE6, IE5 浏览器执行代码
            xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
        xmlhttp.onreadystatechange = function () {
            let opt;
            let ls;
            if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
                const container = document.querySelector('#date_set');
                container.innerHTML = "<option value='-1' selected>--选择日期--</option>"
                //把后台获取到的数据student渲染到页面
                ls = JSON.parse(xmlhttp.responseText)
                for (const idx in ls) {
                    opt = document.createElement("option")
                    opt.value = ls[idx]
                    opt.innerHTML = ls[idx]
                    container.append(opt)
                }
            }
        }
        xmlhttp.open("GET", "http://" + server_ip + ":8899/select_date", true);
        xmlhttp.send();
    }

    function init() {
        const _date = new Date;
        document.querySelector('#rq').valueAsDate = _date;
        document.querySelector('#sjc').value = _date.getHours() + ":" + _date.getMinutes()
    }

    update_date()
    init()
</script>
</body>
</html>