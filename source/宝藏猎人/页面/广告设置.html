<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>广告设置</title>
</head>

<body>
<div>
    <label>服务器: </label>
    <select id="server_ip" onChange="select()">
        <option disabled selected value ="-1">--选择服务器--</option>
        <!-- <option value ="localhost">测试</option> -->
        <option value ="49.235.109.183">服务器1</option>
        <option value ="121.4.27.170">服务器2</option>
    </select></br>
    <hr>
    <h3>广告语</h3>
    <lable>现有文字: </lable>
    <select style="width:200px" id="del_ad" onchange="flash_pre(this)">
        <option disabled selected>---请选择服务器---</option>
    </select>
    <button onclick="select()">更新</button><button onclick="del('del_ad')">删除</button><button onclick="deploy('ad')">展示</button></br>
    <hr>
    <lable>添加文字: </lable> <input style="width:192px" id="ad_text" placeholder="输入要添加的文字"/></br>
    <lable>文字粗细: </lable> <select style="width:200px" id="ad_weight">
        <option value="100">100</option>
        <option value="200">200</option>
        <option value="300">300</option>
        <option value="400" selected>400</option>
        <option value="500">500</option>
        <option value="600">600</option>
        <option value="700">700</option>
        <option value="800">800</option>
        <option value="900">900</option>
    </select></br>
    <lable>文字大小: </lable> <input style="width:192px" id="ad_size" value="18"/></br>
    <lable>文字颜色: </lable> </lable> <select style="width:200px" id="ad_font">
        <option value="black" style="color: black" selected>黑色</option>
        <option value="white" style="color: white">白色</option>
        <option value="red" style="color: red">红色</option>
        <option value="orange" style="color: orange">橙色</option>
        <option value="yellow" style="color: yellow">黄色</option>
        <option value="green" style="color: green">绿色</option>
        <option value="blue" style="color: blue">蓝色</option>
        <option value="purple" style="color: purple">紫色</option>
        <option value="Pink" style="color: Pink">粉色</option>
        <option value="brown" style="color: brown">棕色</option>
    </select></br>
    <lable>文字背景: </lable> </lable> <select style="width:200px" id="ad_bg">
        <option value="black" style="background-color: black">黑色</option>
        <option value="white" style="background-color: white" selected>白色</option>
        <option value="red" style="background-color: red">红色</option>
        <option value="orange" style="background-color: orange">橙色</option>
        <option value="yellow" style="background-color: yellow">黄色</option>
        <option value="green" style="background-color: green">绿色</option>
        <option value="blue" style="background-color: blue">蓝色</option>
        <option value="purple" style="background-color: purple">紫色</option>
        <option value="Pink" style="background-color: Pink">粉色</option>
        <option value="brown" style="background-color: brown">棕色</option>
    </select></br>
    <button onclick="insert('ad')">添加</button><button id="text_pre" onclick="flash_pre(this)">预览</button></br>
    <p style="margin: 0; font-size: 8px;">如果碰上无法添加的情况, 请关闭浏览器的广告拦截插件</p>
    <p style="margin: 0; font-size: 8px;">
        <b style="font-size: 24px">提示:</b>
        换行请使用<b style="color: red">&lt;/br&gt;</b>, 例如:</br>
        欢迎来到<b style="color: red">&lt;/br&gt;</b>我的直播间!</br>↓</br>欢迎来到</br>我的直播间!
    </p>
    <hr style="margin: 0">
    <h3>二维码</h3>
    <lable>现有二维码: </lable>
    <select style="width:200px" id="del_qr" onchange="flash_pre(this)">
        <option disabled selected>---请选择服务器---</option>
    </select>
    <button onclick="select()">更新</button><button onclick="del('del_qr')">删除</button><button onclick="deploy('qr')">展示</button></br>
    <hr style="margin: 0">
    <lable>添加二维码: </lable> <input id="qr" type="file"/>
    <button onclick="insert('qr')">添加</button><button id="qr_pre" onclick="flash_pre(this)">预览</button></br>
    <h3>预览</h3>
    <div id="pre"></div>
</div>
<script type="text/javascript">
console.log("load ad.js")

// 刷新预览
function flash_pre(elm){
    var pre = document.querySelector('#pre')
    pre.innerHTML = ""
    // 待添加文字预览
    if (elm.id == "text_pre") {
        // 设置待添加文字预览
        var text = document.querySelector('#ad_text').value      // 文字
        var weight = document.querySelector('#ad_weight').value  // 粗细
        var size = document.querySelector('#ad_size').value      // 大小
        var font = document.querySelector('#ad_font').value      // 颜色
        var bg = document.querySelector('#ad_bg').value          // 背景色
        var p = document.createElement("p")
        p.style = "font-weight: " + weight + "; font-size: " + size + "px; color: " + font + "; background-color: " + bg + ";"
        p.innerHTML = text
        pre.appendChild(p)
        return
    }
    // 待删除文字预览
    if (elm.id == "del_ad") {
        var p = document.createElement("p")
        p.style = elm[elm.selectedIndex].value
        p.innerHTML = elm[elm.selectedIndex].innerHTML
        pre.appendChild(p)
    }
    // 待添加图片预览
    if (elm.id == "qr_pre"){
        var insert_qr = document.querySelector('#qr')
        if (insert_qr.files.length != 0){
            var reader = new FileReader();
            reader.readAsDataURL(insert_qr.files[0]);
            var img = document.createElement("img")
            reader.onload = function(){
                img.src = this.result
            }
            pre.appendChild(img)
            return
        }
    }
    // 待删除图片预览
    if (elm.id == "del_qr"){
        var server_ip = document.querySelector('#server_ip').value
        if (server_ip == '-1') {
            alert('还未选择服务器')
            return
        }
        if (elm[elm.selectedIndex].value == '') {
            alert('还未选择图片')
            return
        }
        var xmlhttp;
        if (window.XMLHttpRequest) {
            xmlhttp = new XMLHttpRequest();
        } else {
            xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                var img = document.createElement("img")
                img.src = xmlhttp.responseText
                pre.appendChild(img)
            }
        }
        xmlhttp.open("POST", "http://" + server_ip +":8899/ad?action=pic&data=" + elm[elm.selectedIndex].value, false)
        xmlhttp.send()
    }
}
// 获取数据
function select(){
    var server_ip = document.querySelector('#server_ip').value
    if (server_ip == '-1') {
        alert('还未选择服务器')
        return
    }
    var xmlhttp;
    if (window.XMLHttpRequest) {
        xmlhttp = new XMLHttpRequest();
    } else {
        xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
    }
    xmlhttp.onreadystatechange = function () {
        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
            var del_ad = document.querySelector('#del_ad')
            del_ad.innerHTML = ""
            del_ad.innerHTML = '<option disabled selected>--选择内容--</option>'
            // 图片
            var del_qr = document.querySelector('#del_qr')
            del_qr.innerHTML = ""
            del_qr.innerHTML = '<option disabled selected>--选择内容--</option>'
            var obj = JSON.parse(xmlhttp.responseText)
            // 文字
            obj.forEach(element => {
                if (element[1] == 'ad') {
                    var option = document.createElement("option")
                    option.id = element[0]
                    option.innerHTML = element[3]
                    option.value = element[4]
                    del_ad.appendChild(option)
                } else if (element[1] == 'qr') {
                    var option = document.createElement("option")
                    option.id = element[0]
                    option.innerHTML = element[4]
                    option.value = element[4]
                    del_qr.appendChild(option)
                }
            });
        }
    }
    xmlhttp.open("POST", "http://" + server_ip +":8899/ad?action=select", false)
    xmlhttp.send()
    // 初始化图片选项
    // TODO
}

// 删除数据
function del(val){
    var server_ip = document.querySelector('#server_ip').value
    if (server_ip == '-1') {
        alert('还未选择服务器')
        return
    }
    var del_val = document.querySelector('#' + val)
    if (del_val[del_val.selectedIndex].id == "") {
        alert('没有选择项目')
        return
    }
    var xmlhttp;
    if (window.XMLHttpRequest) {
        xmlhttp = new XMLHttpRequest();
    } else {
        xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
    }
    xmlhttp.onreadystatechange = function () {
        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
            select()
            alert('删除完毕')
        }
    }
    xmlhttp.open("GET", "http://" + server_ip +":8899/ad?action=delete&data=" + del_val[del_val.selectedIndex].id, false)
    xmlhttp.send()
}

// 插入数据
function insert(val){
    var server_ip = document.querySelector('#server_ip').value
    if (server_ip == '-1') {
        alert('还未选择服务器')
        return
    }
    if (val == 'ad'){
        var data = document.querySelector('#ad_text').value      // 文字
        var weight = document.querySelector('#ad_weight').value  // 粗细
        var size = document.querySelector('#ad_size').value      // 大小
        var font = document.querySelector('#ad_font').value      // 颜色
        var bg = document.querySelector('#ad_bg').value          // 背景色
        var style = "font-weight: " + weight + "; font-size: " + size + "px; color: " + font + "; background-color: " + bg + ";"
        var args = "type=ad&action=insert&data=" + data + "&parameter=" + style
        var xmlhttp;
        if (window.XMLHttpRequest) {
            xmlhttp = new XMLHttpRequest();
        } else {
            xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                select()
            }
        }
        xmlhttp.open("POST", "http://" + server_ip +":8899/ad?" + args, false)
        xmlhttp.send()
        alert('插入数据完毕')
    } else if (val == 'qr') {
        var args = "type=qr&action=insert"
        var insert_qr = document.querySelector('#qr')
        if (insert_qr.files.length != 0){
            var xmlhttp;
            if (window.XMLHttpRequest) {
                xmlhttp = new XMLHttpRequest();
            } else {
                xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
            }
            var form = new FormData()
            form.append("file", insert_qr.files[0])
            xmlhttp.open("POST", "http://" + server_ip +":8899/ad?" + args, false)
            xmlhttp.send(form)
            alert('插入数据完毕')
        } else {
            alert('还没选择图片')
            return
        }
    }
}
function deploy(val){
    // 选定展示数据
    var server_ip = document.querySelector('#server_ip').value
    if (server_ip == '-1') {
        alert('还未选择服务器')
        return
    }
    var tag = document.querySelector('#del_' + val)
    if (tag[tag.selectedIndex].id == '') {
        alert('还未选择项目')
        return
    }
    var xmlhttp;
    if (window.XMLHttpRequest) {
        xmlhttp = new XMLHttpRequest();
    } else {
        xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
    }
    xmlhttp.onreadystatechange = function () {
        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
            alert('展示数据完毕')
        }
    }
    var tag = document.querySelector('#del_' + val)
    args = "type=" + val + "&action=deploy&data=" + tag[tag.selectedIndex].id
    xmlhttp.open("POST", "http://" + server_ip +":8899/ad?" + args, false)
    xmlhttp.send()
}
</script>
</body>

</html>