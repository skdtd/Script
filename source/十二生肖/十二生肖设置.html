<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate" />
    <title>颜色设置</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            /* border: 0; */
        }
    </style>
</head>
<body>
    <div>
        <table style="text-align: center;" id="colors">
            <tr>
                <th>方向</th>
                <th>字体颜色</th>
                <th>字体背景</th>
            </tr>
            <tr id="鼠">
                <td>鼠</td>
                <td><input type="color"></td>
                <td><input type="color"></td>
            </tr>
            <tr id="牛">
                <td>牛</td>
                <td><input type="color"></td>
                <td><input type="color"></td>
            </tr>
            <tr id="虎">
                <td>虎</td>
                <td><input type="color"></td>
                <td><input type="color"></td>
            </tr>
            <tr id="兔">
                <td>兔</td>
                <td><input type="color"></td>
                <td><input type="color"></td>
            </tr>
            <tr id="龙">
                <td>龙</td>
                <td><input type="color"></td>
                <td><input type="color"></td>
            </tr>
            <tr id="蛇">
                <td>蛇</td>
                <td><input type="color"></td>
                <td><input type="color"></td>
            </tr>
            <tr id="马">
                <td>马</td>
                <td><input type="color"></td>
                <td><input type="color"></td>
            </tr>
            <tr id="羊">
                <td>羊</td>
                <td><input type="color"></td>
                <td><input type="color"></td>
            </tr>
            <tr id="猴">
                <td>猴</td>
                <td><input type="color"></td>
                <td><input type="color"></td>
            </tr>
            <tr id="鸡">
                <td>鸡</td>
                <td><input type="color"></td>
                <td><input type="color"></td>
            </tr>
            <tr id="狗">
                <td>狗</td>
                <td><input type="color"></td>
                <td><input type="color"></td>
            </tr>
            <tr id="猪">
                <td>猪</td>
                <td><input type="color"></td>
                <td><input type="color"></td>
            </tr>
        </table>
    </div>
    <hr>
    <div>
        <table class="setting">
            <tr>
                <td>文字显示</td>
                <td><input id="ad_text" type="text"></td>
            </tr>
            <tr>
                <td>文字大小</td>
                <td><input id="ad_size" min=1 max=100 step=1 value=22 type="number"></td>
            </tr>
            <tr>
                <td>文字颜色</td>
                <td><input id="ad_font" type="color"></td>
            </tr>
            <tr>
                <td>文字背景颜色</td>
                <td><input id="ad_bg" type="color"></td>
            </tr>
        </table>
    </div>
    <hr>
    <div>
        <table class="setting">
            <tr>
                <td>侧边图片</td>
                <td><input id="ad_pic" type="file"></td>
            </tr>
            <tr>
                <td>图片距离页面最左边距离</td>
                <td><input id="ad_pic_x" type="number"></td>
            </tr>
            <tr>
                <td>图片距离页面最顶部距离</td>
                <td><input id="ad_pic_y" type="number"></td>
            </tr>
            <tr>
                <td>图片大小</td>
                <td><input id="ad_pic_size" max=1000 min=1 type="number"></td>
            </tr>
        </table>
    </div>
    <hr>
    <div>
        <table class="setting">
            <tr>
                <td>行数</td>
                <td><input id="row_num" min=1 max=40 step=1 value=20 type="number"></td>
            </tr>
            <tr>
                <td>列数</td>
                <td><input id="col_num" min=1 max=20 step=1 value=6 type="number"></td>
            </tr>
        </table>
    </div>
</body>
<script>
    var server_ip = '49.235.109.183'
    // var server_ip = 'localhost'
    var server_port = 8899
    function ajax_method(url, data, method, success, async) {
        var ajax = new XMLHttpRequest()
        url = 'http://' + server_ip + ':' + server_port + '/' + url
        ajax.open(method, url, async)
        ajax.onreadystatechange = function () {
            if (ajax.readyState == 4 && ajax.status == 200) {
                if (success) {
                    success(ajax.responseText)
                }
            } else {
                // nothing todo
            }
        }
        if (method.toUpperCase() == 'GET') {
            if (data) {
                url += '?'
                url += data
            }
            ajax.send()
        } else if (method.toUpperCase() == 'POST') {
            if (data.constructor.name != 'FormData'){
                ajax.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
            }
            if (data) {
                ajax.send(data)
            } else {
                ajax.send()
            }
        } else {
            console.log('Unsupported method')
        }
    }

    var settings
    ajax_method('setting', null, 'GET', (resp) =>{
        settings = JSON.parse(resp)
    })
    function init_setting() {
        var elms = document.getElementsByClassName('setting')
        var ids = []
        for (var i = 0; i < elms.length; i++) {
            var inputs = elms[i].getElementsByTagName('input')
            for (let i = 0; i < inputs.length; i++) {
                ids.push(inputs[i].id)
            }
        }
        for (i in ids) {
                var input = document.getElementById(ids[i])
                input.value = settings[input.id] ? settings[input.id] : ''
                input.onchange = (e) => {
                    var url = 'setting'
                    if (e.target.type == 'file') {
                        // 文件形式
                        var form = new FormData()
                        form.append("file", e.target.files[0])
                        form.append("key", e.target.id)
                        ajax_method(url, form, 'POST')
                    } else {
                        // 字符形式
                        _max = parseInt(e.target.max)
                        _min = parseInt(e.target.min)
                        _value = parseInt(e.target.value)
                        console.log(e.target.max)
                        console.log(e.target.type)
                        if (e.target.type == 'number') {
                            if (_value > _max){
                                e.target.value = _max
                            } else if (_value < _min){
                                e.target.value = _min
                            }
                        }
                        var data = 'key=' + e.target.id + '&value=' + e.target.value
                        ajax_method(url, data, 'POST')
                    }
                }
            }


    }
    init_setting()
    function init_colors() {
        // 为每个input添加默认选中值
        // 同步请求从服务器获取之前保存的颜色,加载为预显示颜色
        ajax_method('setting', null, 'GET', (resp) => {
            var obj = JSON.parse(resp)
            for (idx in obj) {
                var elm = document.getElementById(idx)
                if (elm.tagName == 'INPUT') {
                    elm.value = obj[idx]
                } else {
                    var inputs = elm.getElementsByTagName('input')
                    fb = obj[idx] ? obj[idx].split(',') : ["#000000", "#000000"]
                    inputs[0].value = fb[0]
                    inputs[1].value = fb[1]
                }
            }
        })

        // 为colors中的每个input添加事件
        var colors = document.getElementById('colors')
        var inputs = colors.getElementsByTagName('input')
        for (let i = 0; i < inputs.length; i++) {
            inputs[i].onchange = () => {
                // 数值修改时向服务器发起异步请求
                var tr = document.getElementById(inputs[i].parentElement.parentElement.id)
                var ins = tr.getElementsByTagName('input')
                var data = 'key=' + inputs[i].parentElement.parentElement.id + "&value=" + ins[0].value + "," + ins[1].value
                ajax_method('setting', data, 'POST', null)
            }
        }
    }
    init_colors()
</script>

</html>